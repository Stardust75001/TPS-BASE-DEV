name: ðŸ”„ Environment Sync

on:
  schedule:
    # Tous les dimanche Ã  02h00 UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      sync_direction:
        description: "Direction de synchronisation"
        required: true
        default: 'dev_to_staging'
        type: choice
        options:
        - dev_to_staging
        - staging_to_prod
        - full_sync
        - backup_only
      environment_target:
        description: "Environnement cible"
        required: false
        type: choice
        options:
        - staging
        - production
        - all

env:
  SHOPIFY_CLI_THEME_TOKEN: ${{ secrets.SHOPIFY_CLI_THEME_TOKEN }}
  SHOPIFY_STORE: ${{ secrets.SHOPIFY_STORE }}
  SHOPIFY_STORE_STAGING: ${{ secrets.SHOPIFY_STORE_STAGING }}
  SHOPIFY_STORE_PROD: ${{ secrets.SHOPIFY_STORE_PROD }}

jobs:
  environment-sync:
    name: "ðŸ”„ Synchronisation Environnements"
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ› ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: |
          npm install -g @shopify/cli @shopify/theme
          npm install

      - name: ðŸ—“ï¸ Generate Sync Timestamp
        id: timestamp
        run: |
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
          mkdir -p "sync-reports/$TIMESTAMP"

      - name: ðŸª Validate Store Connections
        run: |
          echo "ðŸª Validation des connexions stores..."

          stores_validated=0
          total_stores=0

          # Tester DEV store
          if [[ -n "$SHOPIFY_STORE" ]]; then
            total_stores=$((total_stores + 1))
            echo "ðŸ” Test connexion DEV: $SHOPIFY_STORE"
            if shopify theme list --store="$SHOPIFY_STORE" > /dev/null 2>&1; then
              echo "âœ… DEV store accessible"
              stores_validated=$((stores_validated + 1))
              echo "DEV_STORE_OK=true" >> $GITHUB_ENV
            else
              echo "âŒ DEV store inaccessible"
              echo "DEV_STORE_OK=false" >> $GITHUB_ENV
            fi
          fi

          # Tester STAGING store
          if [[ -n "$SHOPIFY_STORE_STAGING" ]]; then
            total_stores=$((total_stores + 1))
            echo "ðŸ” Test connexion STAGING: $SHOPIFY_STORE_STAGING"
            if shopify theme list --store="$SHOPIFY_STORE_STAGING" > /dev/null 2>&1; then
              echo "âœ… STAGING store accessible"
              stores_validated=$((stores_validated + 1))
              echo "STAGING_STORE_OK=true" >> $GITHUB_ENV
            else
              echo "âŒ STAGING store inaccessible"
              echo "STAGING_STORE_OK=false" >> $GITHUB_ENV
            fi
          fi

          # Tester PROD store
          if [[ -n "$SHOPIFY_STORE_PROD" ]]; then
            total_stores=$((total_stores + 1))
            echo "ðŸ” Test connexion PROD: $SHOPIFY_STORE_PROD"
            if shopify theme list --store="$SHOPIFY_STORE_PROD" > /dev/null 2>&1; then
              echo "âœ… PROD store accessible"
              stores_validated=$((stores_validated + 1))
              echo "PROD_STORE_OK=true" >> $GITHUB_ENV
            else
              echo "âŒ PROD store inaccessible"
              echo "PROD_STORE_OK=false" >> $GITHUB_ENV
            fi
          fi

          echo "STORES_VALIDATED=$stores_validated" >> $GITHUB_ENV
          echo "TOTAL_STORES=$total_stores" >> $GITHUB_ENV
          echo "ðŸ“Š Stores validÃ©s: $stores_validated/$total_stores"

      - name: ðŸ’¾ Create Environment Backup
        if: ${{ inputs.sync_direction != 'backup_only' }}
        run: |
          echo "ðŸ’¾ CrÃ©ation backup des environnements..."

          backup_date=$(date +%Y%m%d_%H%M%S)
          mkdir -p "backups/environments/$backup_date"

          # Backup DEV
          if [[ "${DEV_STORE_OK:-false}" == "true" ]]; then
            echo "ðŸ“¥ Backup DEV environment..."
            shopify theme pull --store="$SHOPIFY_STORE" --path="backups/environments/$backup_date/dev" --live || true
          fi

          # Backup STAGING
          if [[ "${STAGING_STORE_OK:-false}" == "true" && -n "$SHOPIFY_STORE_STAGING" ]]; then
            echo "ðŸ“¥ Backup STAGING environment..."
            shopify theme pull --store="$SHOPIFY_STORE_STAGING" --path="backups/environments/$backup_date/staging" --live || true
          fi

          # Backup PROD
          if [[ "${PROD_STORE_OK:-false}" == "true" && -n "$SHOPIFY_STORE_PROD" ]]; then
            echo "ðŸ“¥ Backup PROD environment..."
            shopify theme pull --store="$SHOPIFY_STORE_PROD" --path="backups/environments/$backup_date/production" --live || true
          fi

          echo "BACKUP_PATH=backups/environments/$backup_date" >> $GITHUB_ENV

      - name: ðŸš€ DEV to STAGING Sync
        if: ${{ inputs.sync_direction == 'dev_to_staging' || inputs.sync_direction == 'full_sync' }}
        run: |
          echo "ðŸš€ Synchronisation DEV â†’ STAGING..."

          if [[ "${DEV_STORE_OK:-false}" == "true" && "${STAGING_STORE_OK:-false}" == "true" ]]; then
            # Pull latest from DEV
            echo "ðŸ“¥ Pull du thÃ¨me DEV..."
            rm -rf temp_dev_theme
            shopify theme pull --store="$SHOPIFY_STORE" --path="temp_dev_theme" --live

            # Push to STAGING
            echo "ðŸ“¤ Push vers STAGING..."
            cd temp_dev_theme
            shopify theme push --store="$SHOPIFY_STORE_STAGING" --live --force
            cd ..

            echo "âœ… DEV â†’ STAGING synchronisÃ©"
            echo "DEV_TO_STAGING_SUCCESS=true" >> $GITHUB_ENV
          else
            echo "âŒ Impossible de synchroniser DEV â†’ STAGING (stores indisponibles)"
            echo "DEV_TO_STAGING_SUCCESS=false" >> $GITHUB_ENV
          fi

      - name: ðŸŽ¯ STAGING to PROD Sync
        if: ${{ inputs.sync_direction == 'staging_to_prod' || inputs.sync_direction == 'full_sync' }}
        run: |
          echo "ðŸŽ¯ Synchronisation STAGING â†’ PROD..."

          if [[ "${STAGING_STORE_OK:-false}" == "true" && "${PROD_STORE_OK:-false}" == "true" ]]; then
            # Confirmation supplÃ©mentaire pour PROD
            echo "âš ï¸ ATTENTION: DÃ©ploiement vers PRODUCTION"

            # Pull latest from STAGING
            echo "ðŸ“¥ Pull du thÃ¨me STAGING..."
            rm -rf temp_staging_theme
            shopify theme pull --store="$SHOPIFY_STORE_STAGING" --path="temp_staging_theme" --live

            # Push to PROD (avec extra care)
            echo "ðŸ“¤ Push vers PRODUCTION..."
            cd temp_staging_theme
            shopify theme push --store="$SHOPIFY_STORE_PROD" --live --force
            cd ..

            echo "âœ… STAGING â†’ PROD synchronisÃ©"
            echo "STAGING_TO_PROD_SUCCESS=true" >> $GITHUB_ENV
          else
            echo "âŒ Impossible de synchroniser STAGING â†’ PROD (stores indisponibles)"
            echo "STAGING_TO_PROD_SUCCESS=false" >> $GITHUB_ENV
          fi

      - name: ðŸ”§ Environment Configuration Sync
        run: |
          echo "ðŸ”§ Synchronisation des configurations..."

          # VÃ©rifier les variables d'environnement critiques
          config_sync_issues=0

          echo "ðŸ” VÃ©rification variables critiques..."

          # Liste des variables importantes Ã  synchroniser
          critical_vars=("GTM_ID" "GA4_ID" "FB_PIXEL_ID" "SENTRY_DSN")

          for var in "${critical_vars[@]}"; do
            if [[ -z "${!var:-}" ]]; then
              echo "âš ï¸ Variable manquante: $var" >> "sync-reports/$TIMESTAMP/config_issues.log"
              config_sync_issues=$((config_sync_issues + 1))
            else
              echo "âœ… Variable configurÃ©e: $var"
            fi
          done

          echo "CONFIG_SYNC_ISSUES=$config_sync_issues" >> $GITHUB_ENV
          echo "ðŸ“Š ProblÃ¨mes de configuration: $config_sync_issues"

      - name: ðŸ“‹ Environment Health Check
        run: |
          echo "ðŸ“‹ VÃ©rification santÃ© des environnements..."

          health_issues=0

          # Tester l'accÃ¨s aux thÃ¨mes sur chaque store
          if [[ "${DEV_STORE_OK:-false}" == "true" ]]; then
            echo "ðŸ” Health check DEV..."
            theme_count=$(shopify theme list --store="$SHOPIFY_STORE" --json 2>/dev/null | jq length 2>/dev/null || echo "0")
            echo "DEV themes: $theme_count"
            if [[ "$theme_count" == "0" ]]; then
              health_issues=$((health_issues + 1))
            fi
          fi

          if [[ "${STAGING_STORE_OK:-false}" == "true" ]]; then
            echo "ðŸ” Health check STAGING..."
            theme_count=$(shopify theme list --store="$SHOPIFY_STORE_STAGING" --json 2>/dev/null | jq length 2>/dev/null || echo "0")
            echo "STAGING themes: $theme_count"
            if [[ "$theme_count" == "0" ]]; then
              health_issues=$((health_issues + 1))
            fi
          fi

          if [[ "${PROD_STORE_OK:-false}" == "true" ]]; then
            echo "ðŸ” Health check PROD..."
            theme_count=$(shopify theme list --store="$SHOPIFY_STORE_PROD" --json 2>/dev/null | jq length 2>/dev/null || echo "0")
            echo "PROD themes: $theme_count"
            if [[ "$theme_count" == "0" ]]; then
              health_issues=$((health_issues + 1))
            fi
          fi

          echo "HEALTH_ISSUES=$health_issues" >> $GITHUB_ENV
          echo "ðŸ“Š ProblÃ¨mes de santÃ© dÃ©tectÃ©s: $health_issues"

      - name: ðŸ“Š Generate Sync Report
        run: |
          echo "ðŸ“Š GÃ©nÃ©ration du rapport de synchronisation..."

          cat > "sync-reports/$TIMESTAMP/SYNC_REPORT.md" << EOF
          # ðŸ”„ RAPPORT SYNCHRONISATION ENVIRONNEMENTS - TPS

          **Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')
          **Type:** ${{ inputs.sync_direction || 'scheduled' }}
          **Environnement Cible:** ${{ inputs.environment_target || 'all' }}

          ## ðŸª Status Stores

          - **DEV Store:** $(if [[ "${DEV_STORE_OK:-false}" == "true" ]]; then echo "âœ… Accessible"; else echo "âŒ Inaccessible"; fi) ($SHOPIFY_STORE)
          - **STAGING Store:** $(if [[ "${STAGING_STORE_OK:-false}" == "true" ]]; then echo "âœ… Accessible"; else echo "âŒ Inaccessible"; fi) ($SHOPIFY_STORE_STAGING)
          - **PROD Store:** $(if [[ "${PROD_STORE_OK:-false}" == "true" ]]; then echo "âœ… Accessible"; else echo "âŒ Inaccessible"; fi) ($SHOPIFY_STORE_PROD)

          **Stores ValidÃ©s:** ${STORES_VALIDATED:-0}/${TOTAL_STORES:-0}

          ## ðŸ”„ OpÃ©rations de Synchronisation

          ### DEV â†’ STAGING
          - **Status:** $(if [[ "${DEV_TO_STAGING_SUCCESS:-false}" == "true" ]]; then echo "âœ… SuccÃ¨s"; elif [[ "${{ inputs.sync_direction }}" == *"staging"* ]]; then echo "âŒ Ã‰chec"; else echo "âž– Non demandÃ©"; fi)

          ### STAGING â†’ PROD
          - **Status:** $(if [[ "${STAGING_TO_PROD_SUCCESS:-false}" == "true" ]]; then echo "âœ… SuccÃ¨s"; elif [[ "${{ inputs.sync_direction }}" == *"prod"* ]]; then echo "âŒ Ã‰chec"; else echo "âž– Non demandÃ©"; fi)

          ## ðŸ”§ Configuration

          - **ProblÃ¨mes Config:** ${CONFIG_SYNC_ISSUES:-0}
          - **Status Config:** $(if [[ "${CONFIG_SYNC_ISSUES:-0}" == "0" ]]; then echo "âœ… OK"; else echo "âš ï¸ Ã€ corriger"; fi)

          ## ðŸ“‹ SantÃ© Environnements

          - **ProblÃ¨mes SantÃ©:** ${HEALTH_ISSUES:-0}
          - **Status Global:** $(if [[ "${HEALTH_ISSUES:-0}" == "0" ]]; then echo "âœ… Excellent"; else echo "âš ï¸ Attention requise"; fi)

          ## ðŸ’¾ Sauvegardes

          - **Backup CrÃ©Ã©:** $(if [[ -n "${BACKUP_PATH:-}" ]]; then echo "âœ… ${BACKUP_PATH}"; else echo "âž– Non crÃ©Ã©"; fi)
          - **RÃ©tention:** 30 jours

          ## ðŸ“… Planification

          - **Prochaine Sync:** $(date -d '+1 week' '+%Y-%m-%d') (Automatique hebdomadaire)
          - **Sync Manuel:** Disponible via workflow dispatch

          ## ðŸŽ¯ Actions RecommandÃ©es

          $(if [[ "${STORES_VALIDATED:-0}" != "${TOTAL_STORES:-0}" ]]; then
            echo "- ðŸ”§ VÃ©rifier les connexions stores dÃ©faillantes"
          fi
          if [[ "${CONFIG_SYNC_ISSUES:-0}" -gt 0 ]]; then
            echo "- âš™ï¸ Corriger les variables d'environnement manquantes"
          fi
          if [[ "${HEALTH_ISSUES:-0}" -gt 0 ]]; then
            echo "- ðŸ¥ Investiguer les problÃ¨mes de santÃ© des environnements"
          fi
          if [[ "${DEV_TO_STAGING_SUCCESS:-false}" == "false" && "${{ inputs.sync_direction }}" == *"staging"* ]]; then
            echo "- ðŸ”„ Relancer la synchronisation DEV â†’ STAGING"
          fi)

          ---

          **GÃ©nÃ©rÃ© automatiquement par GitHub Actions Environment Sync**
          EOF

      - name: ðŸ“¤ Upload Sync Reports
        uses: actions/upload-artifact@v3
        with:
          name: environment-sync-${{ env.TIMESTAMP }}
          path: |
            sync-reports/${{ env.TIMESTAMP }}/
            ${{ env.BACKUP_PATH || 'backups/empty' }}
          retention-days: 30

      - name: ðŸ“ Display Sync Summary
        run: |
          echo "## ðŸ”„ Synchronisation Environnements" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ—“ï¸ Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸŽ¯ Type:** ${{ inputs.sync_direction || 'scheduled' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸª Status Stores" >> $GITHUB_STEP_SUMMARY
          echo "- DEV: $(if [[ "${DEV_STORE_OK:-false}" == "true" ]]; then echo "âœ…"; else echo "âŒ"; fi) $SHOPIFY_STORE" >> $GITHUB_STEP_SUMMARY
          echo "- STAGING: $(if [[ "${STAGING_STORE_OK:-false}" == "true" ]]; then echo "âœ…"; else echo "âŒ"; fi) $SHOPIFY_STORE_STAGING" >> $GITHUB_STEP_SUMMARY
          echo "- PROD: $(if [[ "${PROD_STORE_OK:-false}" == "true" ]]; then echo "âœ…"; else echo "âŒ"; fi) $SHOPIFY_STORE_PROD" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ”„ RÃ©sultats Sync" >> $GITHUB_STEP_SUMMARY
          echo "- **DEV â†’ STAGING:** $(if [[ "${DEV_TO_STAGING_SUCCESS:-false}" == "true" ]]; then echo "âœ… SuccÃ¨s"; elif [[ "${{ inputs.sync_direction }}" == *"staging"* ]]; then echo "âŒ Ã‰chec"; else echo "âž– Non demandÃ©"; fi)" >> $GITHUB_STEP_SUMMARY
          echo "- **STAGING â†’ PROD:** $(if [[ "${STAGING_TO_PROD_SUCCESS:-false}" == "true" ]]; then echo "âœ… SuccÃ¨s"; elif [[ "${{ inputs.sync_direction }}" == *"prod"* ]]; then echo "âŒ Ã‰chec"; else echo "âž– Non demandÃ©"; fi)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          total_issues=$((${CONFIG_SYNC_ISSUES:-0} + ${HEALTH_ISSUES:-0}))
          echo "**ðŸ“Š ProblÃ¨mes DÃ©tectÃ©s:** $total_issues" >> $GITHUB_STEP_SUMMARY

          if [[ $total_issues -eq 0 ]]; then
            echo "ðŸŸ¢ **Tous les environnements sont synchronisÃ©s et sains**" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸŸ¡ **Attention requise sur les environnements**" >> $GITHUB_STEP_SUMMARY
          fi
