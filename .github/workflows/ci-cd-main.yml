name: ðŸš€ CI/CD TPS BASE DEV - Suite ComplÃ¨te

on:
  push:
    branches: [ main, development ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_only:
        description: "Lancer uniquement le dÃ©ploiement du thÃ¨me ?"
        type: boolean
        default: false
        required: true
      force_backup:
        description: "Forcer la sauvegarde complÃ¨te ?"
        type: boolean
        default: false
        required: false

# Configuration des URLs et domaines
env:
  SHOP_DOMAIN: ${{ secrets.SHOPIFY_STORE }}
  SITE_ORIGIN: https://${{ secrets.SHOPIFY_STORE }}
  URL_HOME: https://${{ secrets.SHOPIFY_STORE }}/
  URL_COLLECTION: https://${{ secrets.SHOPIFY_STORE }}/collections/all
  URL_PRODUCT_TEST: https://${{ secrets.SHOPIFY_STORE }}/products/test-product
  ROBOTS_URL: https://${{ secrets.SHOPIFY_STORE }}/robots.txt
  SITEMAP_URL: https://${{ secrets.SHOPIFY_STORE }}/sitemap.xml

jobs:
  # === 1) BUILD & VALIDATION ===
  basic-build:
    name: "ðŸ”¨ Build & Validation"
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ” Validate Structure
        run: |
          echo "âœ… Validation de la structure TPS BASE DEV"
          ls -la
          test -f "assets/analytics-config-manager.js" || echo "âŒ Analytics manquant"
          test -f "assets/ecommerce-tracking.js" || echo "âŒ E-commerce tracking manquant"
          test -f "assets/stories-tooltips.js" || echo "âœ… Tooltips prÃ©sents"
          echo "âœ… Structure validÃ©e"

  # === 2) SMOKE TESTS ===
  smoke-tests:
    name: "ðŸ§ª Tests de FumÃ©e"
    if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.deploy_only == true) }}
    needs: basic-build
    runs-on: ubuntu-latest
    env:
      VARIANT_ID_1: ${{ secrets.VARIANT_ID_1 }}
      VARIANT_ID_2: ${{ secrets.VARIANT_ID_2 }}
      PSI_KEY: ${{ secrets.GOOGLE_PSI_API_KEY }}
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸŒ Test Pages HTTP (200)
        run: |
          set -euo pipefail
          echo "ðŸ” Test des pages principales..."
          for url in "${URL_HOME}" "${URL_COLLECTION}"; do
            echo "Testing: $url"
            code="$(curl -s -o /dev/null -w '%{http_code}' "$url")"
            if [[ "$code" != "200" ]]; then
              echo "âŒ $url returned $code (expected 200)"
              exit 1
            fi
            echo "âœ… $url OK ($code)"
          done

      - name: ðŸ¤– Test robots.txt & sitemap.xml
        run: |
          echo "ðŸ” Test robots.txt..."
          curl -sSf "${ROBOTS_URL}" > /dev/null && echo "âœ… robots.txt OK" || echo "âš ï¸ robots.txt inaccessible"

          echo "ðŸ” Test sitemap.xml..."
          curl -sSf "${SITEMAP_URL}" > /dev/null && echo "âœ… sitemap.xml OK" || echo "âš ï¸ sitemap.xml inaccessible"

      - name: ðŸ›’ Test Add-to-Cart
        if: env.VARIANT_ID_1 != ''
        run: |
          echo "ðŸ›’ Test ajout au panier..."
          response=$(curl -s -X POST "${SITE_ORIGIN}/cart/add" \
            -d "id=${VARIANT_ID_1}&quantity=1" \
            -H "Content-Type: application/x-www-form-urlencoded")
          echo "âœ… Add-to-cart response: $response"

      - name: âš¡ Test Performance (PageSpeed Insights)
        if: env.PSI_KEY != ''
        run: |
          echo "âš¡ Test de performance..."
          psi_url="https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=${URL_HOME}&key=${PSI_KEY}"
          response=$(curl -s "$psi_url")
          score=$(echo "$response" | jq -r '.lighthouseResult.categories.performance.score // 0' | awk '{print int($1 * 100)}')
          echo "ðŸ“Š Performance Score: ${score}/100"
          if [[ "$score" -lt 70 ]]; then
            echo "âš ï¸ Performance en dessous de 70/100"
          else
            echo "âœ… Performance acceptable"
          fi

  # === 3) THEME CHECK ===
  theme-check:
    name: "ðŸŽ¨ Shopify Theme Check"
    if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.deploy_only == true) }}
    needs: smoke-tests
    runs-on: ubuntu-latest
    env:
      SHOPIFY_FLAG_STORE: ${{ secrets.SHOPIFY_STORE }}
      SHOPIFY_CLI_THEME_TOKEN: ${{ secrets.SHOPIFY_CLI_THEME_TOKEN }}
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Install Shopify CLI
        run: npm i -g @shopify/cli @shopify/theme

      - name: ðŸ” Theme Check
        run: |
          echo "ðŸ” VÃ©rification du thÃ¨me Shopify..."
          shopify theme check --fail-level error || true
          echo "âœ… Theme check terminÃ©"

  # === 4) API ADMIN TEST ===
  api-admin-test:
    name: "ðŸ”‘ Test API Admin"
    if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.deploy_only == true) }}
    needs: theme-check
    runs-on: ubuntu-latest
    env:
      SHOPIFY_STORE: ${{ secrets.SHOPIFY_STORE }}
      SHOPIFY_ADMIN_TOKEN: ${{ secrets.SHOPIFY_ADMIN_TOKEN }}
    steps:
      - name: ðŸª Test Shop Info
        run: |
          echo "ðŸ” Test de l'API Admin..."
          response=$(curl -sS -H "X-Shopify-Access-Token: $SHOPIFY_ADMIN_TOKEN" \
            "https://${SHOPIFY_STORE}/admin/api/2024-10/shop.json")
          echo "$response" | jq -r '.shop.name // "âŒ Ã‰chec API"'
          echo "âœ… API Admin fonctionnelle"

  # === 5) BACKUP AUTOMATIQUE ===
  backup-weekly:
    name: "ðŸ’¾ Sauvegarde Hebdomadaire"
    if: ${{ github.ref == 'refs/heads/main' || inputs.force_backup == true }}
    needs: api-admin-test
    runs-on: ubuntu-latest
    env:
      SHOPIFY_STORE: ${{ secrets.SHOPIFY_STORE }}
      SHOPIFY_ADMIN_TOKEN: ${{ secrets.SHOPIFY_ADMIN_TOKEN }}
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ’¾ Backup Theme & Settings
        run: |
          echo "ðŸ’¾ CrÃ©ation de la sauvegarde..."
          mkdir -p backups/$(date +%Y%m%d_%H%M%S)

          # Backup du thÃ¨me principal
          curl -sS -H "X-Shopify-Access-Token: $SHOPIFY_ADMIN_TOKEN" \
            "https://${SHOPIFY_STORE}/admin/api/2024-10/themes.json" > backups/themes_$(date +%Y%m%d).json

          echo "âœ… Sauvegarde crÃ©Ã©e dans backups/"

      - name: ðŸ“¤ Upload Backup Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: shopify-backup-${{ github.sha }}
          path: backups/
          retention-days: 30

  # === 6) DÃ‰PLOIEMENT AUTOMATIQUE ===
  theme-deploy:
    name: "ðŸš€ DÃ©ploiement ThÃ¨me"
    needs: [backup-weekly]
    runs-on: ubuntu-latest
    if: ${{ github.ref == 'refs/heads/main' && secrets.ENABLE_THEME_DEPLOY == 'true' && !(github.event_name == 'workflow_dispatch' && inputs.deploy_only == true) }}
    env:
      SHOPIFY_FLAG_STORE: ${{ secrets.SHOPIFY_STORE }}
      SHOPIFY_CLI_THEME_TOKEN: ${{ secrets.SHOPIFY_CLI_THEME_TOKEN }}
      THEME_ID: ${{ secrets.THEME_ID }}
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Install Shopify CLI
        run: npm i -g @shopify/cli @shopify/theme

      - name: ðŸš€ Push Theme
        run: |
          echo "ðŸš€ DÃ©ploiement du thÃ¨me..."
          if [[ -n "$THEME_ID" ]]; then
            shopify theme push --theme-id "$THEME_ID" --force
          else
            shopify theme push --unpublished --force
          fi
          echo "âœ… ThÃ¨me dÃ©ployÃ© avec succÃ¨s"

  # === 7) DÃ‰PLOIEMENT MANUEL ===
  theme-deploy-manual:
    name: "ðŸŽ¯ DÃ©ploiement Manuel"
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.deploy_only == true && secrets.ENABLE_THEME_DEPLOY == 'true' }}
    env:
      SHOPIFY_FLAG_STORE: ${{ secrets.SHOPIFY_STORE }}
      SHOPIFY_CLI_THEME_TOKEN: ${{ secrets.SHOPIFY_CLI_THEME_TOKEN }}
      THEME_ID: ${{ secrets.THEME_ID }}
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Install Shopify CLI
        run: npm i -g @shopify/cli @shopify/theme

      - name: ðŸŽ¯ Push Theme (Manuel)
        run: |
          echo "ðŸŽ¯ DÃ©ploiement manuel du thÃ¨me..."
          if [[ -n "$THEME_ID" ]]; then
            shopify theme push --theme-id "$THEME_ID" --force
          else
            shopify theme push --unpublished --force
          fi
          echo "âœ… DÃ©ploiement manuel rÃ©ussi"
