name: ðŸ”„ Auto-Sync & PR Management

on:
  workflow_dispatch:
    inputs:
      sync_type:
        description: 'Type de synchronisation'
        required: true
        default: 'smart'
        type: choice
        options:
        - smart
        - force
        - backup-first
      create_pr:
        description: 'CrÃ©er une PR automatiquement'
        required: false
        default: true
        type: boolean
  schedule:
    # Tous les vendredis Ã  16h00 UTC (18h00 Paris) pour sync hebdo
    - cron: '0 16 * * 5'

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  auto-sync:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: ðŸ› ï¸ Setup environment
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Auto-Sync"

    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ðŸ“Š Pre-sync Analysis
      id: pre_analysis
      run: |
        echo "=== ANALYSE PRE-SYNCHRONISATION ===" > sync_report.txt

        # VÃ©rifier l'Ã©tat du repo
        UNCOMMITTED=$(git status --porcelain | wc -l)
        UNTRACKED=$(git ls-files --others --exclude-standard | wc -l)
        MODIFIED=$(git diff --name-only | wc -l)

        echo "ðŸ“ Fichiers non commitÃ©s: $UNCOMMITTED" >> sync_report.txt
        echo "ðŸ“ Fichiers non trackÃ©s: $UNTRACKED" >> sync_report.txt
        echo "ðŸ“ Fichiers modifiÃ©s: $MODIFIED" >> sync_report.txt

        # VÃ©rifier la connectivitÃ© avec origin
        git fetch origin main || echo "âš ï¸ ProblÃ¨me de connectivitÃ© avec origin" >> sync_report.txt

        # VÃ©rifier les conflits potentiels
        BEHIND=$(git rev-list --count HEAD..origin/main 2>/dev/null || echo "0")
        AHEAD=$(git rev-list --count origin/main..HEAD 2>/dev/null || echo "0")

        echo "ðŸ“ˆ Commits en retard: $BEHIND" >> sync_report.txt
        echo "ðŸ“‰ Commits en avance: $AHEAD" >> sync_report.txt

        echo "uncommitted=$UNCOMMITTED" >> $GITHUB_OUTPUT
        echo "untracked=$UNTRACKED" >> $GITHUB_OUTPUT
        echo "behind=$BEHIND" >> $GITHUB_OUTPUT
        echo "ahead=$AHEAD" >> $GITHUB_OUTPUT

        # DÃ©terminer la stratÃ©gie de sync
        TOTAL_CHANGES=$((UNCOMMITTED + UNTRACKED))
        if [ $TOTAL_CHANGES -gt 0 ]; then
          echo "sync_needed=true" >> $GITHUB_OUTPUT
          echo "ðŸ”„ Synchronisation nÃ©cessaire: $TOTAL_CHANGES changement(s)" >> sync_report.txt
        else
          echo "sync_needed=false" >> $GITHUB_OUTPUT
          echo "âœ… Repository dÃ©jÃ  synchronisÃ©" >> sync_report.txt
        fi

    - name: ðŸ”’ Security Pre-Check
      if: steps.pre_analysis.outputs.sync_needed == 'true'
      id: security_precheck
      run: |
        echo "=== VÃ‰RIFICATION SÃ‰CURITÃ‰ PRE-SYNC ===" >> sync_report.txt

        # Scan rapide des secrets
        SECRETS_COUNT=0

        # Chercher des secrets dans les fichiers modifiÃ©s
        if [ -n "$(git status --porcelain)" ]; then
          git status --porcelain | while read status file; do
            if [[ "$file" =~ \.(liquid|js|json)$ ]]; then
              # VÃ©rifier les secrets dans ce fichier
              SECRETS_IN_FILE=$(grep -E "sk_live_|pk_live_|AIza[A-Za-z0-9]{35}|ghp_|gho_|ghu_|ghs_|ghr_" "$file" 2>/dev/null | wc -l || echo "0")
              if [ $SECRETS_IN_FILE -gt 0 ]; then
                echo "ðŸš¨ Secrets dÃ©tectÃ©s dans $file: $SECRETS_IN_FILE" >> sync_report.txt
                SECRETS_COUNT=$((SECRETS_COUNT + SECRETS_IN_FILE))
              fi
            fi
          done
        fi

        echo "security_issues=$SECRETS_COUNT" >> $GITHUB_OUTPUT

        if [ $SECRETS_COUNT -gt 0 ]; then
          echo "ðŸš¨ BLOCAGE: Secrets dÃ©tectÃ©s avant synchronisation!" >> sync_report.txt
          echo "security_block=true" >> $GITHUB_OUTPUT
        else
          echo "âœ… Aucun secret dÃ©tectÃ©" >> sync_report.txt
          echo "security_block=false" >> $GITHUB_OUTPUT
        fi

    - name: ðŸ›‘ Block if Security Issues
      if: steps.security_precheck.outputs.security_block == 'true'
      run: |
        echo "ðŸš¨ SYNCHRONISATION BLOQUÃ‰E: Secrets dÃ©tectÃ©s dans le code!"
        echo "Veuillez corriger les problÃ¨mes de sÃ©curitÃ© avant de continuer."
        cat sync_report.txt
        exit 1

    - name: ðŸ’¾ Create Backup Branch
      if: steps.pre_analysis.outputs.sync_needed == 'true' && (github.event.inputs.sync_type == 'backup-first' || github.event.inputs.sync_type == 'smart')
      run: |
        BACKUP_BRANCH="backup/pre-sync-$(date +%Y%m%d_%H%M%S)"
        git checkout -b $BACKUP_BRANCH
        git add .
        git commit -m "ðŸ—„ï¸ Backup before auto-sync: $(date)" || echo "Nothing to backup"
        git push origin $BACKUP_BRANCH || echo "Backup push failed"
        git checkout main
        echo "backup_branch=$BACKUP_BRANCH" >> $GITHUB_ENV
        echo "ðŸ“¦ Backup crÃ©Ã©: $BACKUP_BRANCH" >> sync_report.txt

    - name: ðŸ§¹ Smart Cleanup
      if: steps.pre_analysis.outputs.sync_needed == 'true'
      run: |
        echo "=== NETTOYAGE INTELLIGENT ===" >> sync_report.txt

        # Nettoyer les fichiers temporaires
        find . -name "*.bak" -delete || true
        find . -name "*.tmp" -delete || true
        find . -name ".DS_Store" -delete || true
        find . -name "Thumbs.db" -delete || true

        # Corriger les permissions
        chmod +x *.sh 2>/dev/null || true

        # Nettoyer les console.log dans les fichiers liquid (seulement si pas trop)
        CONSOLE_COUNT=$(grep -r "console\." --include="*.liquid" . | wc -l || echo "0")
        if [ $CONSOLE_COUNT -lt 10 ]; then
          find . -name "*.liquid" -exec sed -i.bak 's/console\.log([^;]*);*//g' {} \; 2>/dev/null || true
          find . -name "*.bak" -delete || true
          echo "ðŸ§¹ Console.log nettoyÃ©s: $CONSOLE_COUNT" >> sync_report.txt
        fi

        # Moderniser les filtres Shopify (img_url -> image_url)
        DEPRECATED_COUNT=$(find . -name "*.liquid" -exec grep -l "img_url" {} \; | wc -l || echo "0")
        if [ $DEPRECATED_COUNT -lt 50 ]; then
          find . -name "*.liquid" -exec sed -i.bak 's/| *img_url/| image_url/g' {} \; 2>/dev/null || true
          find . -name "*.bak" -delete || true
          echo "ðŸ”„ Filtres modernisÃ©s: $DEPRECATED_COUNT fichiers" >> sync_report.txt
        fi

        echo "âœ… Nettoyage terminÃ©" >> sync_report.txt

    - name: ðŸ“ Validate JSON Files
      if: steps.pre_analysis.outputs.sync_needed == 'true'
      run: |
        echo "=== VALIDATION JSON ===" >> sync_report.txt
        JSON_ERRORS=0

        for file in locales/*.json; do
          if [ -f "$file" ]; then
            if python3 -m json.tool "$file" > /dev/null 2>&1; then
              echo "âœ… $(basename "$file")" >> sync_report.txt
            else
              echo "âŒ $(basename "$file") - ERREUR JSON" >> sync_report.txt
              JSON_ERRORS=$((JSON_ERRORS + 1))
            fi
          fi
        done

        if [ $JSON_ERRORS -gt 0 ]; then
          echo "âš ï¸ $JSON_ERRORS erreur(s) JSON dÃ©tectÃ©e(s) mais sync continue" >> sync_report.txt
        else
          echo "âœ… Tous les JSON sont valides" >> sync_report.txt
        fi

    - name: ðŸ”„ Intelligent Commit Strategy
      if: steps.pre_analysis.outputs.sync_needed == 'true'
      run: |
        echo "=== STRATÃ‰GIE DE COMMIT ===" >> sync_report.txt

        # Analyser les types de changements
        LIQUID_CHANGES=$(git status --porcelain | grep "\.liquid$" | wc -l || echo "0")
        JSON_CHANGES=$(git status --porcelain | grep "\.json$" | wc -l || echo "0")
        JS_CHANGES=$(git status --porcelain | grep "\.js$" | wc -l || echo "0")
        CONFIG_CHANGES=$(git status --porcelain | grep -E "\.(yml|yaml|sh|md)$" | wc -l || echo "0")

        echo "ðŸŽ¨ Templates Liquid: $LIQUID_CHANGES" >> sync_report.txt
        echo "ðŸ“ Fichiers JSON: $JSON_CHANGES" >> sync_report.txt
        echo "âš¡ Scripts JS: $JS_CHANGES" >> sync_report.txt
        echo "âš™ï¸ Configuration: $CONFIG_CHANGES" >> sync_report.txt

        # CrÃ©er un message de commit intelligent
        COMMIT_MSG="ðŸš€ Auto-sync $(date +%Y%m%d): "

        if [ $LIQUID_CHANGES -gt 0 ]; then
          COMMIT_MSG="${COMMIT_MSG}Templates ($LIQUID_CHANGES), "
        fi
        if [ $JSON_CHANGES -gt 0 ]; then
          COMMIT_MSG="${COMMIT_MSG}Locales ($JSON_CHANGES), "
        fi
        if [ $JS_CHANGES -gt 0 ]; then
          COMMIT_MSG="${COMMIT_MSG}Scripts ($JS_CHANGES), "
        fi
        if [ $CONFIG_CHANGES -gt 0 ]; then
          COMMIT_MSG="${COMMIT_MSG}Config ($CONFIG_CHANGES), "
        fi

        # Nettoyer le message
        COMMIT_MSG=$(echo "$COMMIT_MSG" | sed 's/, $//')

        # Ajouter des dÃ©tails automatiques
        COMMIT_MSG="${COMMIT_MSG}

        ðŸ”§ Optimisations automatiques:
        - Filtres Shopify modernisÃ©s
        - Console.log nettoyÃ©s
        - Fichiers temporaires supprimÃ©s
        - Permissions corrigÃ©es

        ðŸ“Š RÃ©sumÃ©:
        - Templates: $LIQUID_CHANGES
        - Traductions: $JSON_CHANGES
        - Scripts: $JS_CHANGES
        - Configuration: $CONFIG_CHANGES

        ðŸ¤– GÃ©nÃ©rÃ© automatiquement par GitHub Actions"

        echo "commit_message<<EOF" >> $GITHUB_ENV
        echo "$COMMIT_MSG" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

        echo "ðŸ“ Message de commit prÃ©parÃ©" >> sync_report.txt

    - name: ðŸ’¾ Commit All Changes
      if: steps.pre_analysis.outputs.sync_needed == 'true'
      run: |
        git add .
        git status

        if [ -n "$(git status --porcelain)" ]; then
          git commit -m "${{ env.commit_message }}"
          echo "âœ… Commit crÃ©Ã© avec succÃ¨s" >> sync_report.txt
        else
          echo "â„¹ï¸ Aucun changement Ã  commiter aprÃ¨s nettoyage" >> sync_report.txt
        fi

    - name: ðŸŒ¿ Create Feature Branch for PR
      if: steps.pre_analysis.outputs.sync_needed == 'true' && (github.event.inputs.create_pr == 'true' || github.event_name == 'schedule')
      run: |
        FEATURE_BRANCH="auto-sync/weekly-$(date +%Y%m%d)"
        git checkout -b $FEATURE_BRANCH
        echo "feature_branch=$FEATURE_BRANCH" >> $GITHUB_ENV
        echo "ðŸŒ¿ Branche crÃ©Ã©e: $FEATURE_BRANCH" >> sync_report.txt

    - name: ðŸ“¤ Push Changes
      if: steps.pre_analysis.outputs.sync_needed == 'true'
      run: |
        if [ -n "${{ env.feature_branch }}" ]; then
          # Push sur la branche feature pour PR
          git push origin ${{ env.feature_branch }}
          echo "ðŸ“¤ Push sur branche feature: ${{ env.feature_branch }}" >> sync_report.txt
        else
          # Push direct sur main
          git push origin main
          echo "ðŸ“¤ Push direct sur main" >> sync_report.txt
        fi

    - name: ðŸ”„ Create Auto-PR
      if: steps.pre_analysis.outputs.sync_needed == 'true' && env.feature_branch != '' && (github.event.inputs.create_pr == 'true' || github.event_name == 'schedule')
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ env.feature_branch }}
        title: "ðŸš€ Weekly Auto-Sync - $(date +%d/%m/%Y)"
        body: |
          ## ðŸ”„ Synchronisation Automatique Hebdomadaire

          **ðŸ“… Date**: $(date '+%d/%m/%Y Ã  %H:%M UTC')
          **ðŸ¤– Type**: Synchronisation automatique
          **ðŸŒ¿ Branche**: `${{ env.feature_branch }}`

          ### ðŸ“Š RÃ©sumÃ© des Changements

          - **ðŸ“ Fichiers non trackÃ©s**: ${{ steps.pre_analysis.outputs.untracked }}
          - **ðŸ“ Fichiers modifiÃ©s**: ${{ steps.pre_analysis.outputs.uncommitted }}
          - **ðŸ”„ Commits en retard**: ${{ steps.pre_analysis.outputs.behind }}

          ### ðŸ”§ Optimisations AppliquÃ©es

          - âœ… Nettoyage des fichiers temporaires
          - âœ… Correction des permissions des scripts
          - âœ… Modernisation des filtres Shopify
          - âœ… Suppression des console.log
          - âœ… Validation JSON

          ### ðŸ›¡ï¸ VÃ©rifications SÃ©curitÃ©

          - âœ… Aucun secret dÃ©tectÃ© dans le code
          - âœ… Fichiers sensibles vÃ©rifiÃ©s
          - âœ… Backup crÃ©Ã©: `${{ env.backup_branch }}`

          ### âœ… Checklist Pre-Merge

          - [ ] VÃ©rifier les changements en local
          - [ ] Tester les fonctionnalitÃ©s modifiÃ©es
          - [ ] Valider l'affichage du thÃ¨me
          - [ ] Confirmer la sÃ©curitÃ©

          ### ðŸš€ Actions Post-Merge

          Cette PR sera automatiquement:
          - TestÃ©e par les GitHub Actions
          - AnalysÃ©e pour la performance
          - VÃ©rifiÃ©e pour la sÃ©curitÃ©

          ---

          *ðŸ¤– PR gÃ©nÃ©rÃ©e automatiquement par le workflow de synchronisation*
          *ðŸ“‹ Consultez les artifacts pour le rapport complet*
        labels: |
          automation
          weekly-sync
          enhancement
        assignees: Stardust75001
        draft: false

    - name: ðŸ“Š Final Report
      if: always()
      run: |
        echo "" >> sync_report.txt
        echo "=== RAPPORT FINAL DE SYNCHRONISATION ===" >> sync_report.txt
        echo "ðŸ“… Date: $(date '+%d/%m/%Y Ã  %H:%M UTC')" >> sync_report.txt
        echo "ðŸ”„ Type: ${{ github.event.inputs.sync_type || 'scheduled' }}" >> sync_report.txt
        echo "ðŸŒ¿ Branche crÃ©Ã©e: ${{ env.feature_branch || 'N/A' }}" >> sync_report.txt
        echo "ðŸ“¦ Backup: ${{ env.backup_branch || 'N/A' }}" >> sync_report.txt
        echo "ðŸŽ¯ Synchronisation nÃ©cessaire: ${{ steps.pre_analysis.outputs.sync_needed }}" >> sync_report.txt
        echo "ðŸ”’ ProblÃ¨mes sÃ©curitÃ©: ${{ steps.security_precheck.outputs.security_issues || '0' }}" >> sync_report.txt
        echo "" >> sync_report.txt
        echo "âœ… Synchronisation terminÃ©e avec succÃ¨s!" >> sync_report.txt

        cat sync_report.txt

    - name: ðŸ’¾ Save Sync Report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: sync-report-$(date +%Y%m%d_%H%M)
        path: sync_report.txt
        retention-days: 90
