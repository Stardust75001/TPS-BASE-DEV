name: ðŸ“Š Analytics & Monitoring TPS BASE DEV

on:
  schedule:
    # Tous les jours Ã  8h00 UTC (9h00 CET) 
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      monitoring_type:
        description: "Type de monitoring"
        required: true
        default: 'complete'
        type: choice
        options:
        - complete
        - analytics_only
        - uptime_only
        - errors_only

env:
  SHOPIFY_STORE: ${{ secrets.SHOPIFY_STORE }}
  SITE_ORIGIN: https://${{ secrets.SHOPIFY_STORE }}
  SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
  GTM_ID: ${{ secrets.GTM_ID }}
  GA4_ID: ${{ secrets.GA4_ID }}

jobs:
  monitoring:
    name: "ðŸ“Š Monitoring & Analytics"
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ—“ï¸ Generate Report Timestamp  
        id: timestamp
        run: |
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          REPORT_DATE=$(date +"%Y-%m-%d %H:%M:%S UTC")
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
          echo "REPORT_DATE=$REPORT_DATE" >> $GITHUB_ENV

      - name: ðŸ“ Create Monitoring Directory
        run: |
          mkdir -p "reports/monitoring/$TIMESTAMP"

      - name: ðŸ” Uptime Check
        if: ${{ inputs.monitoring_type == 'complete' || inputs.monitoring_type == 'uptime_only' }}
        run: |
          echo "ðŸ” VÃ©rification uptime..."
          
          # Pages principales Ã  tester
          pages=(
            "${SITE_ORIGIN}/"
            "${SITE_ORIGIN}/collections/all"
            "${SITE_ORIGIN}/pages/about"
            "${SITE_ORIGIN}/cart"
          )
          
          uptime_ok=0
          uptime_total=0
          
          for page in "${pages[@]}"; do
            echo "Testing: $page"
            uptime_total=$((uptime_total + 1))
            
            start_time=$(date +%s.%N)
            http_code=$(curl -s -o /dev/null -w '%{http_code}' --max-time 10 "$page")
            end_time=$(date +%s.%N)
            
            response_time=$(echo "$end_time - $start_time" | bc -l | xargs printf "%.3f")
            
            if [[ "$http_code" == "200" ]]; then
              uptime_ok=$((uptime_ok + 1))
              echo "âœ… $page OK ($response_time s)"
              echo "$page,$http_code,$response_time,OK" >> "reports/monitoring/$TIMESTAMP/uptime.csv"
            else
              echo "âŒ $page ERROR $http_code ($response_time s)"
              echo "$page,$http_code,$response_time,ERROR" >> "reports/monitoring/$TIMESTAMP/uptime.csv"
            fi
          done
          
          uptime_percent=$(echo "scale=2; $uptime_ok * 100 / $uptime_total" | bc -l)
          echo "UPTIME_PERCENT=$uptime_percent" >> $GITHUB_ENV
          echo "ðŸ“Š Uptime: $uptime_percent% ($uptime_ok/$uptime_total)"

      - name: ðŸ“Š Analytics Check
        if: ${{ inputs.monitoring_type == 'complete' || inputs.monitoring_type == 'analytics_only' }}
        run: |
          echo "ðŸ“Š VÃ©rification analytics..."
          
          # VÃ©rifier la prÃ©sence des scripts analytics sur la homepage
          homepage_html=$(curl -s "$SITE_ORIGIN/")
          
          # GTM Check
          if echo "$homepage_html" | grep -q "googletagmanager.com/gtm.js"; then
            echo "GTM_PRESENT=true" >> $GITHUB_ENV
            echo "âœ… Google Tag Manager dÃ©tectÃ©"
          else
            echo "GTM_PRESENT=false" >> $GITHUB_ENV
            echo "âš ï¸ Google Tag Manager non dÃ©tectÃ©"
          fi
          
          # GA4 Check  
          if echo "$homepage_html" | grep -q "gtag.*${GA4_ID}"; then
            echo "GA4_PRESENT=true" >> $GITHUB_ENV
            echo "âœ… Google Analytics 4 dÃ©tectÃ©"
          else
            echo "GA4_PRESENT=false" >> $GITHUB_ENV
            echo "âš ï¸ Google Analytics 4 non dÃ©tectÃ©"
          fi
          
          # Facebook Pixel Check
          if echo "$homepage_html" | grep -q "connect.facebook.net"; then
            echo "FB_PIXEL_PRESENT=true" >> $GITHUB_ENV
            echo "âœ… Facebook Pixel dÃ©tectÃ©"
          else
            echo "FB_PIXEL_PRESENT=false" >> $GITHUB_ENV
            echo "âš ï¸ Facebook Pixel non dÃ©tectÃ©"
          fi
          
          # Analytics Suite Check
          if echo "$homepage_html" | grep -q "analytics-config-manager"; then
            echo "ANALYTICS_SUITE_PRESENT=true" >> $GITHUB_ENV
            echo "âœ… TPS Analytics Suite dÃ©tectÃ©"
          else
            echo "ANALYTICS_SUITE_PRESENT=false" >> $GITHUB_ENV
            echo "âš ï¸ TPS Analytics Suite non dÃ©tectÃ©"
          fi

      - name: ðŸ› Error Monitoring
        if: ${{ inputs.monitoring_type == 'complete' || inputs.monitoring_type == 'errors_only' }}
        run: |
          echo "ðŸ› Monitoring des erreurs..."
          
          # VÃ©rifier les erreurs JavaScript sur la homepage
          # Note: Simulation car nous ne pouvons pas exÃ©cuter JS dans GitHub Actions
          
          # VÃ©rifier les logs 404 potentiels en testant des ressources communes
          common_files=(
            "/favicon.ico"
            "/robots.txt"
            "/sitemap.xml"
            "/assets/application.css"
            "/assets/application.js"
          )
          
          error_count=0
          
          for file in "${common_files[@]}"; do
            url="${SITE_ORIGIN}${file}"
            http_code=$(curl -s -o /dev/null -w '%{http_code}' --max-time 5 "$url")
            
            if [[ "$http_code" == "404" ]]; then
              error_count=$((error_count + 1))
              echo "âŒ 404: $file"
              echo "$file,404,$(date)" >> "reports/monitoring/$TIMESTAMP/errors.csv"
            elif [[ "$http_code" != "200" ]]; then
              echo "âš ï¸ $http_code: $file"
            fi
          done
          
          echo "ERROR_COUNT=$error_count" >> $GITHUB_ENV
          echo "ðŸ› Erreurs dÃ©tectÃ©es: $error_count"

      - name: ðŸš€ Performance Check
        if: ${{ inputs.monitoring_type == 'complete' }}
        run: |
          echo "ðŸš€ VÃ©rification performance..."
          
          # Test de temps de rÃ©ponse des pages critiques
          critical_pages=(
            "/"
            "/collections/all"
            "/cart"
          )
          
          total_response_time=0
          page_count=0
          
          for page in "${critical_pages[@]}"; do
            url="${SITE_ORIGIN}${page}"
            
            start_time=$(date +%s.%N)
            curl -s -o /dev/null --max-time 10 "$url"
            end_time=$(date +%s.%N)
            
            response_time=$(echo "$end_time - $start_time" | bc -l)
            total_response_time=$(echo "$total_response_time + $response_time" | bc -l)
            page_count=$((page_count + 1))
            
            echo "âš¡ $page: ${response_time}s"
          done
          
          avg_response_time=$(echo "scale=3; $total_response_time / $page_count" | bc -l)
          echo "AVG_RESPONSE_TIME=$avg_response_time" >> $GITHUB_ENV
          echo "ðŸ“Š Temps de rÃ©ponse moyen: ${avg_response_time}s"

      - name: ðŸ“Š Generate Monitoring Report
        run: |
          echo "ðŸ“Š GÃ©nÃ©ration du rapport monitoring..."
          
          cat > "reports/monitoring/$TIMESTAMP/MONITORING_REPORT.md" << EOF
          # ðŸ“Š RAPPORT MONITORING - TPS BASE DEV
          
          **Date:** $REPORT_DATE
          **Store:** $SHOPIFY_STORE
          **Type:** ${{ inputs.monitoring_type || 'complete' }}
          
          ## ðŸ” Uptime & DisponibilitÃ©
          
          - **Uptime:** ${UPTIME_PERCENT:-'Non testÃ©'}%
          - **Pages testÃ©es:** Accueil, Collections, Panier, Ã€ propos
          - **Temps de rÃ©ponse moyen:** ${AVG_RESPONSE_TIME:-'Non testÃ©'}s
          
          ## ðŸ“Š Analytics & Tracking
          
          - **Google Tag Manager:** ${GTM_PRESENT:-'Non testÃ©'}
          - **Google Analytics 4:** ${GA4_PRESENT:-'Non testÃ©'}  
          - **Facebook Pixel:** ${FB_PIXEL_PRESENT:-'Non testÃ©'}
          - **TPS Analytics Suite:** ${ANALYTICS_SUITE_PRESENT:-'Non testÃ©'}
          
          ## ðŸ› Monitoring des Erreurs
          
          - **Erreurs 404 dÃ©tectÃ©es:** ${ERROR_COUNT:-'Non testÃ©'}
          - **Status:** $(if [[ "${ERROR_COUNT:-0}" -eq 0 ]]; then echo "âœ… Aucune erreur"; else echo "âš ï¸ Erreurs Ã  investiguer"; fi)
          
          ## ðŸ“ˆ Tendances & Alertes
          
          ### âœ… Points Positifs
          
          $(if [[ "${UPTIME_PERCENT:-0}" -ge 95 ]]; then echo "- âœ… Excellent uptime (â‰¥95%)"; fi)
          $(if [[ "${GTM_PRESENT}" == "true" ]]; then echo "- âœ… Google Tag Manager fonctionnel"; fi)  
          $(if [[ "${ANALYTICS_SUITE_PRESENT}" == "true" ]]; then echo "- âœ… Suite analytics TPS active"; fi)
          $(if [[ "${ERROR_COUNT:-0}" -eq 0 ]]; then echo "- âœ… Aucune erreur 404 dÃ©tectÃ©e"; fi)
          
          ### âš ï¸ Points d'Attention
          
          $(if [[ "${UPTIME_PERCENT:-100}" -lt 95 ]]; then echo "- âš ï¸ Uptime en dessous de 95%"; fi)
          $(if [[ "${GTM_PRESENT}" != "true" ]]; then echo "- âš ï¸ Google Tag Manager non dÃ©tectÃ©"; fi)
          $(if [[ "${GA4_PRESENT}" != "true" ]]; then echo "- âš ï¸ Google Analytics 4 non dÃ©tectÃ©"; fi)
          $(if [[ "${FB_PIXEL_PRESENT}" != "true" ]]; then echo "- âš ï¸ Facebook Pixel non dÃ©tectÃ©"; fi)
          $(if [[ "${ERROR_COUNT:-0}" -gt 0 ]]; then echo "- âš ï¸ ${ERROR_COUNT} erreur(s) 404 dÃ©tectÃ©e(s)"; fi)
          
          ## ðŸŽ¯ Actions RecommandÃ©es
          
          1. Surveiller l'uptime quotidiennement
          2. VÃ©rifier les scripts analytics aprÃ¨s chaque dÃ©ploiement
          3. Corriger les erreurs 404 identifiÃ©es
          4. Maintenir des temps de rÃ©ponse < 3 secondes
          
          ---
          
          **Prochain monitoring:** $(date -d '+1 day' '+%Y-%m-%d')
          **GÃ©nÃ©rÃ© automatiquement par GitHub Actions**
          EOF
          
          echo "âœ… Rapport monitoring gÃ©nÃ©rÃ©"

      - name: ðŸ“¤ Upload Monitoring Report
        uses: actions/upload-artifact@v3
        with:
          name: monitoring-report-${{ env.TIMESTAMP }}
          path: reports/monitoring/${{ env.TIMESTAMP }}/
          retention-days: 30

      - name: ðŸ“ Display Summary  
        run: |
          echo "## ðŸ“Š Rapport Monitoring Quotidien" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ—“ï¸ Date:** $REPORT_DATE" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸª Store:** $SHOPIFY_STORE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ” Uptime & Performance" >> $GITHUB_STEP_SUMMARY
          echo "- Uptime: ${UPTIME_PERCENT:-'Non testÃ©'}%" >> $GITHUB_STEP_SUMMARY
          echo "- Temps de rÃ©ponse moyen: ${AVG_RESPONSE_TIME:-'Non testÃ©'}s" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“Š Analytics" >> $GITHUB_STEP_SUMMARY
          echo "- GTM: $(if [[ "${GTM_PRESENT}" == "true" ]]; then echo "âœ… OK"; else echo "âŒ NOK"; fi)" >> $GITHUB_STEP_SUMMARY
          echo "- GA4: $(if [[ "${GA4_PRESENT}" == "true" ]]; then echo "âœ… OK"; else echo "âŒ NOK"; fi)" >> $GITHUB_STEP_SUMMARY
          echo "- Suite TPS: $(if [[ "${ANALYTICS_SUITE_PRESENT}" == "true" ]]; then echo "âœ… OK"; else echo "âŒ NOK"; fi)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ› Erreurs" >> $GITHUB_STEP_SUMMARY
          echo "- Erreurs 404: ${ERROR_COUNT:-'Non testÃ©'}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${ERROR_COUNT:-0}" -gt 0 ]] || [[ "${UPTIME_PERCENT:-100}" -lt 95 ]]; then
            echo "âš ï¸ **Des problÃ¨mes nÃ©cessitent votre attention**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Tous les systÃ¨mes fonctionnent correctement**" >> $GITHUB_STEP_SUMMARY
          fi