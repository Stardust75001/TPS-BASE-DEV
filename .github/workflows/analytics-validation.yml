name: ðŸ“Š Analytics Validation

on:
  schedule:
    # Tous les jours Ã  10h00 UTC (11h00 CET)
    - cron: '0 10 * * *'
  workflow_dispatch:
    inputs:
      validation_type:
        description: "Type de validation analytics"
        required: true
        default: 'complete'
        type: choice
        options:
        - complete
        - gtm_only
        - ga4_only
        - pixels_only
        - quick_check

env:
  SHOPIFY_STORE: ${{ secrets.SHOPIFY_STORE }}
  SITE_ORIGIN: https://${{ secrets.SHOPIFY_STORE }}
  GTM_ID: ${{ secrets.GTM_ID }}
  GA4_ID: ${{ secrets.GA4_ID }}

jobs:
  analytics-validation:
    name: "ðŸ“Š Validation Suite Analytics"
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ—“ï¸ Generate Report Timestamp
        id: timestamp
        run: |
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV

      - name: ðŸ“ Create Reports Directory
        run: mkdir -p "reports/analytics/$TIMESTAMP"

      - name: ðŸŽ¯ Test GTM Implementation
        if: ${{ inputs.validation_type == 'complete' || inputs.validation_type == 'gtm_only' }}
        run: |
          echo "ðŸŽ¯ Validation Google Tag Manager..."

          # TÃ©lÃ©charger la page d'accueil
          curl -s "$SITE_ORIGIN/" > "reports/analytics/$TIMESTAMP/homepage.html"

          # VÃ©rifier prÃ©sence GTM
          if grep -q "googletagmanager.com/gtm.js" "reports/analytics/$TIMESTAMP/homepage.html"; then
            echo "GTM_SCRIPT_PRESENT=true" >> $GITHUB_ENV
            echo "âœ… Script GTM dÃ©tectÃ©"
          else
            echo "GTM_SCRIPT_PRESENT=false" >> $GITHUB_ENV
            echo "âŒ Script GTM non dÃ©tectÃ©"
          fi

          # VÃ©rifier noscript GTM
          if grep -q "googletagmanager.com/ns.html" "reports/analytics/$TIMESTAMP/homepage.html"; then
            echo "GTM_NOSCRIPT_PRESENT=true" >> $GITHUB_ENV
            echo "âœ… Noscript GTM dÃ©tectÃ©"
          else
            echo "GTM_NOSCRIPT_PRESENT=false" >> $GITHUB_ENV
            echo "âŒ Noscript GTM non dÃ©tectÃ©"
          fi

          # VÃ©rifier ID GTM correct
          if grep -q "$GTM_ID" "reports/analytics/$TIMESTAMP/homepage.html"; then
            echo "GTM_ID_CORRECT=true" >> $GITHUB_ENV
            echo "âœ… GTM ID correct: $GTM_ID"
          else
            echo "GTM_ID_CORRECT=false" >> $GITHUB_ENV
            echo "âŒ GTM ID incorrect ou absent"
          fi

      - name: ðŸ“ˆ Test GA4 Implementation
        if: ${{ inputs.validation_type == 'complete' || inputs.validation_type == 'ga4_only' }}
        run: |
          echo "ðŸ“ˆ Validation Google Analytics 4..."

          # VÃ©rifier script GA4
          if grep -q "gtag.*config.*$GA4_ID" "reports/analytics/$TIMESTAMP/homepage.html"; then
            echo "GA4_CONFIG_PRESENT=true" >> $GITHUB_ENV
            echo "âœ… Configuration GA4 dÃ©tectÃ©e: $GA4_ID"
          else
            echo "GA4_CONFIG_PRESENT=false" >> $GITHUB_ENV
            echo "âŒ Configuration GA4 non dÃ©tectÃ©e"
          fi

          # VÃ©rifier gtag.js
          if grep -q "googletagmanager.com/gtag/js" "reports/analytics/$TIMESTAMP/homepage.html"; then
            echo "GTAG_SCRIPT_PRESENT=true" >> $GITHUB_ENV
            echo "âœ… Script gtag.js dÃ©tectÃ©"
          else
            echo "GTAG_SCRIPT_PRESENT=false" >> $GITHUB_ENV
            echo "âŒ Script gtag.js non dÃ©tectÃ©"
          fi

      - name: ðŸ“± Test Social Pixels
        if: ${{ inputs.validation_type == 'complete' || inputs.validation_type == 'pixels_only' }}
        run: |
          echo "ðŸ“± Validation pixels rÃ©seaux sociaux..."

          # Facebook Pixel
          if grep -q "connect.facebook.net" "reports/analytics/$TIMESTAMP/homepage.html"; then
            echo "FB_PIXEL_PRESENT=true" >> $GITHUB_ENV
            echo "âœ… Facebook Pixel dÃ©tectÃ©"
          else
            echo "FB_PIXEL_PRESENT=false" >> $GITHUB_ENV
            echo "âŒ Facebook Pixel non dÃ©tectÃ©"
          fi

          # TikTok Pixel
          if grep -q "analytics.tiktok.com" "reports/analytics/$TIMESTAMP/homepage.html"; then
            echo "TIKTOK_PIXEL_PRESENT=true" >> $GITHUB_ENV
            echo "âœ… TikTok Pixel dÃ©tectÃ©"
          else
            echo "TIKTOK_PIXEL_PRESENT=false" >> $GITHUB_ENV
            echo "âŒ TikTok Pixel non dÃ©tectÃ©"
          fi

          # Pinterest Tag
          if grep -q "pintrk" "reports/analytics/$TIMESTAMP/homepage.html"; then
            echo "PINTEREST_TAG_PRESENT=true" >> $GITHUB_ENV
            echo "âœ… Pinterest Tag dÃ©tectÃ©"
          else
            echo "PINTEREST_TAG_PRESENT=false" >> $GITHUB_ENV
            echo "âŒ Pinterest Tag non dÃ©tectÃ©"
          fi

      - name: ðŸŽ¨ Test TPS Analytics Suite
        if: ${{ inputs.validation_type == 'complete' }}
        run: |
          echo "ðŸŽ¨ Validation TPS Analytics Suite..."

          # Analytics config manager
          if grep -q "analytics-config-manager" "reports/analytics/$TIMESTAMP/homepage.html"; then
            echo "TPS_ANALYTICS_PRESENT=true" >> $GITHUB_ENV
            echo "âœ… TPS Analytics Suite dÃ©tectÃ©"
          else
            echo "TPS_ANALYTICS_PRESENT=false" >> $GITHUB_ENV
            echo "âŒ TPS Analytics Suite non dÃ©tectÃ©"
          fi

          # E-commerce tracking
          if grep -q "ecommerce-tracking" "reports/analytics/$TIMESTAMP/homepage.html"; then
            echo "ECOMMERCE_TRACKING_PRESENT=true" >> $GITHUB_ENV
            echo "âœ… E-commerce Tracking dÃ©tectÃ©"
          else
            echo "ECOMMERCE_TRACKING_PRESENT=false" >> $GITHUB_ENV
            echo "âŒ E-commerce Tracking non dÃ©tectÃ©"
          fi

      - name: ðŸ” Quick Health Check
        if: ${{ inputs.validation_type == 'quick_check' }}
        run: |
          echo "ðŸ” VÃ©rification rapide..."

          # Test basique de prÃ©sence analytics
          analytics_count=0

          if grep -q "gtag\|fbq\|analytics" "reports/analytics/$TIMESTAMP/homepage.html"; then
            analytics_count=$((analytics_count + 1))
          fi

          echo "QUICK_ANALYTICS_COUNT=$analytics_count" >> $GITHUB_ENV
          echo "ðŸ“Š $analytics_count service(s) analytics dÃ©tectÃ©(s)"

      - name: ðŸ“Š Generate Analytics Report
        run: |
          echo "ðŸ“Š GÃ©nÃ©ration du rapport analytics..."

          cat > "reports/analytics/$TIMESTAMP/ANALYTICS_REPORT.md" << EOF
          # ðŸ“Š RAPPORT VALIDATION ANALYTICS - TPS BASE DEV

          **Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')
          **Store:** $SHOPIFY_STORE
          **Type:** ${{ inputs.validation_type || 'complete' }}

          ## ðŸŽ¯ Google Tag Manager

          - **Script GTM:** ${GTM_SCRIPT_PRESENT:-'Non testÃ©'}
          - **Noscript GTM:** ${GTM_NOSCRIPT_PRESENT:-'Non testÃ©'}
          - **ID GTM Correct:** ${GTM_ID_CORRECT:-'Non testÃ©'}
          - **ID Attendu:** $GTM_ID

          ## ðŸ“ˆ Google Analytics 4

          - **Configuration GA4:** ${GA4_CONFIG_PRESENT:-'Non testÃ©'}
          - **Script gtag.js:** ${GTAG_SCRIPT_PRESENT:-'Non testÃ©'}
          - **ID Attendu:** $GA4_ID

          ## ðŸ“± Pixels RÃ©seaux Sociaux

          - **Facebook Pixel:** ${FB_PIXEL_PRESENT:-'Non testÃ©'}
          - **TikTok Pixel:** ${TIKTOK_PIXEL_PRESENT:-'Non testÃ©'}
          - **Pinterest Tag:** ${PINTEREST_TAG_PRESENT:-'Non testÃ©'}

          ## ðŸŽ¨ TPS Analytics Suite

          - **Analytics Manager:** ${TPS_ANALYTICS_PRESENT:-'Non testÃ©'}
          - **E-commerce Tracking:** ${ECOMMERCE_TRACKING_PRESENT:-'Non testÃ©'}

          ## âœ… Score Global

          $(total=0; success=0
          for var in GTM_SCRIPT_PRESENT GTM_ID_CORRECT GA4_CONFIG_PRESENT FB_PIXEL_PRESENT TPS_ANALYTICS_PRESENT; do
            value=$(printenv $var 2>/dev/null || echo "false")
            if [[ "$value" != "Non testÃ©" ]]; then
              total=$((total + 1))
              if [[ "$value" == "true" ]]; then
                success=$((success + 1))
              fi
            fi
          done
          if [[ $total -gt 0 ]]; then
            score=$((success * 100 / total))
            echo "**Score Analytics:** $success/$total ($score%)"
            if [[ $score -ge 80 ]]; then
              echo "âœ… **Excellent - Analytics bien configurÃ©**"
            elif [[ $score -ge 60 ]]; then
              echo "âš ï¸ **Bon - Quelques amÃ©liorations possibles**"
            else
              echo "âŒ **Critique - Configuration incomplÃ¨te**"
            fi
          else
            echo "**Score:** Non calculÃ©"
          fi)

          ## ðŸŽ¯ Recommandations

          $(if [[ "${GTM_SCRIPT_PRESENT:-false}" != "true" ]]; then
            echo "- âš ï¸ Configurer Google Tag Manager"
          fi
          if [[ "${GA4_CONFIG_PRESENT:-false}" != "true" ]]; then
            echo "- âš ï¸ VÃ©rifier la configuration GA4"
          fi
          if [[ "${FB_PIXEL_PRESENT:-false}" != "true" ]]; then
            echo "- âš ï¸ Installer Facebook Pixel"
          fi
          if [[ "${TPS_ANALYTICS_PRESENT:-false}" != "true" ]]; then
            echo "- âš ï¸ Activer TPS Analytics Suite"
          fi)

          ---

          **Prochain audit:** $(date -d '+1 day' '+%Y-%m-%d')
          **GÃ©nÃ©rÃ© automatiquement par GitHub Actions**
          EOF

          echo "âœ… Rapport analytics gÃ©nÃ©rÃ©"

      - name: ðŸ“¤ Upload Analytics Report
        uses: actions/upload-artifact@v3
        with:
          name: analytics-report-${{ env.TIMESTAMP }}
          path: reports/analytics/${{ env.TIMESTAMP }}/
          retention-days: 30

      - name: ðŸ“ Display Summary
        run: |
          echo "## ðŸ“Š Validation Analytics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ—“ï¸ Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸª Store:** $SHOPIFY_STORE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸŽ¯ Google Tag Manager" >> $GITHUB_STEP_SUMMARY
          echo "- Script: $(if [[ "${GTM_SCRIPT_PRESENT:-false}" == "true" ]]; then echo "âœ… OK"; else echo "âŒ NOK"; fi)" >> $GITHUB_STEP_SUMMARY
          echo "- ID Correct: $(if [[ "${GTM_ID_CORRECT:-false}" == "true" ]]; then echo "âœ… OK"; else echo "âŒ NOK"; fi)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“ˆ Analytics & Pixels" >> $GITHUB_STEP_SUMMARY
          echo "- GA4: $(if [[ "${GA4_CONFIG_PRESENT:-false}" == "true" ]]; then echo "âœ… OK"; else echo "âŒ NOK"; fi)" >> $GITHUB_STEP_SUMMARY
          echo "- Facebook: $(if [[ "${FB_PIXEL_PRESENT:-false}" == "true" ]]; then echo "âœ… OK"; else echo "âŒ NOK"; fi)" >> $GITHUB_STEP_SUMMARY
          echo "- TPS Suite: $(if [[ "${TPS_ANALYTICS_PRESENT:-false}" == "true" ]]; then echo "âœ… OK"; else echo "âŒ NOK"; fi)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Calculer le score global
          total=0; success=0
          for var in GTM_SCRIPT_PRESENT GTM_ID_CORRECT GA4_CONFIG_PRESENT FB_PIXEL_PRESENT TPS_ANALYTICS_PRESENT; do
            value=$(printenv $var 2>/dev/null || echo "false")
            if [[ "$value" != "Non testÃ©" ]]; then
              total=$((total + 1))
              if [[ "$value" == "true" ]]; then
                success=$((success + 1))
              fi
            fi
          done

          if [[ $total -gt 0 ]]; then
            score=$((success * 100 / total))
            echo "**ðŸ“Š Score Global:** $success/$total ($score%)" >> $GITHUB_STEP_SUMMARY
            if [[ $score -ge 80 ]]; then
              echo "âœ… **Configuration analytics excellente**" >> $GITHUB_STEP_SUMMARY
            elif [[ $score -ge 60 ]]; then
              echo "âš ï¸ **Configuration analytics Ã  amÃ©liorer**" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Configuration analytics critique**" >> $GITHUB_STEP_SUMMARY
            fi
          fi
