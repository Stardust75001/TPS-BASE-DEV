name: ðŸš¨ Security Monitoring

on:
  schedule:
    # Tous les jours Ã  05h00 UTC
    - cron: '0 5 * * *'
  push:
    paths:
      - 'assets/**'
      - 'config/**'
      - 'snippets/**'
      - 'layout/**'
      - '.env*'
  workflow_dispatch:
    inputs:
      scan_type:
        description: "Type de scan sÃ©curitÃ©"
        required: true
        default: 'complete'
        type: choice
        options:
        - complete
        - secrets_only
        - dependencies_only
        - code_quality
        - vulnerability_scan

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  security-scan:
    name: "ðŸš¨ Scan SÃ©curitÃ© TPS"
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ—“ï¸ Generate Security Report
        id: timestamp
        run: |
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
          mkdir -p "reports/security/$TIMESTAMP"

      - name: ðŸ” Secrets Detection Scan
        if: ${{ inputs.scan_type == 'complete' || inputs.scan_type == 'secrets_only' }}
        run: |
          echo "ðŸ” DÃ©tection des secrets exposÃ©s..."

          # Patterns de secrets dangereux
          cat > "reports/security/$TIMESTAMP/secret_patterns.txt" << EOF
          sk_live_[0-9a-zA-Z]{24,}
          sk_test_[0-9a-zA-Z]{24,}
          pk_live_[0-9a-zA-Z]{24,}
          pk_test_[0-9a-zA-Z]{24,}
          AIza[0-9A-Za-z_-]{35}
          AKIA[0-9A-Z]{16}
          [0-9]+-[0-9A-Za-z_]{32}\.apps\.googleusercontent\.com
          shpat_[a-fA-F0-9]{32}
          shpss_[a-fA-F0-9]{32}
          shpca_[a-fA-F0-9]{32}
          shppa_[a-fA-F0-9]{32}
          EOF

          # Scanner tous les fichiers
          secrets_found=0
          while IFS= read -r pattern; do
            echo "ðŸ”Ž Recherche pattern: $pattern"
            if grep -r --exclude-dir=.git --exclude-dir=node_modules --exclude="*.yml" -E "$pattern" . > /dev/null 2>&1; then
              echo "âŒ ALERTE: Pattern dÃ©tectÃ© - $pattern" >> "reports/security/$TIMESTAMP/secrets_alert.log"
              secrets_found=$((secrets_found + 1))
            fi
          done < "reports/security/$TIMESTAMP/secret_patterns.txt"

          echo "SECRETS_FOUND=$secrets_found" >> $GITHUB_ENV

          if [[ $secrets_found -gt 0 ]]; then
            echo "âŒ $secrets_found secret(s) potentiel(s) dÃ©tectÃ©(s)"
          else
            echo "âœ… Aucun secret exposÃ© dÃ©tectÃ©"
          fi

      - name: ðŸ“¦ Dependencies Security Audit
        if: ${{ inputs.scan_type == 'complete' || inputs.scan_type == 'dependencies_only' }}
        run: |
          echo "ðŸ“¦ Audit sÃ©curitÃ© des dÃ©pendances..."

          if [[ -f "package.json" ]]; then
            # Installer npm audit si Node.js disponible
            if command -v npm &> /dev/null; then
              echo "ðŸ” Audit npm en cours..."
              npm audit --audit-level=moderate --json > "reports/security/$TIMESTAMP/npm_audit.json" 2>/dev/null || true

              # Compter les vulnÃ©rabilitÃ©s
              if [[ -f "reports/security/$TIMESTAMP/npm_audit.json" ]]; then
                vulnerabilities=$(jq -r '.metadata.vulnerabilities | (.info + .low + .moderate + .high + .critical)' "reports/security/$TIMESTAMP/npm_audit.json" 2>/dev/null || echo "0")
                echo "NPM_VULNERABILITIES=$vulnerabilities" >> $GITHUB_ENV
                echo "ðŸ“Š VulnÃ©rabilitÃ©s NPM trouvÃ©es: $vulnerabilities"
              else
                echo "NPM_VULNERABILITIES=unknown" >> $GITHUB_ENV
              fi
            else
              echo "âš ï¸ npm non disponible pour l'audit"
              echo "NPM_VULNERABILITIES=unavailable" >> $GITHUB_ENV
            fi
          else
            echo "â„¹ï¸ Pas de package.json trouvÃ©"
            echo "NPM_VULNERABILITIES=none" >> $GITHUB_ENV
          fi

      - name: ðŸ’» Code Quality Analysis
        if: ${{ inputs.scan_type == 'complete' || inputs.scan_type == 'code_quality' }}
        run: |
          echo "ðŸ’» Analyse qualitÃ© du code..."

          # Rechercher code JavaScript potentiellement dangereux
          dangerous_patterns=0

          echo "ðŸ”Ž Recherche eval() et Function()..."
          if grep -r --include="*.js" --include="*.liquid" "\beval\s*(" . > /dev/null 2>&1; then
            echo "âŒ Usage eval() dÃ©tectÃ©" >> "reports/security/$TIMESTAMP/code_quality.log"
            dangerous_patterns=$((dangerous_patterns + 1))
          fi

          if grep -r --include="*.js" --include="*.liquid" "new Function(" . > /dev/null 2>&1; then
            echo "âŒ Usage new Function() dÃ©tectÃ©" >> "reports/security/$TIMESTAMP/code_quality.log"
            dangerous_patterns=$((dangerous_patterns + 1))
          fi

          echo "ðŸ”Ž Recherche innerHTML non sÃ©curisÃ©..."
          if grep -r --include="*.js" "innerHTML\s*=" . > /dev/null 2>&1; then
            echo "âš ï¸ Usage innerHTML dÃ©tectÃ©" >> "reports/security/$TIMESTAMP/code_quality.log"
            dangerous_patterns=$((dangerous_patterns + 1))
          fi

          echo "ðŸ”Ž Recherche document.write()..."
          if grep -r --include="*.js" --include="*.liquid" "document\.write\s*(" . > /dev/null 2>&1; then
            echo "âš ï¸ Usage document.write() dÃ©tectÃ©" >> "reports/security/$TIMESTAMP/code_quality.log"
            dangerous_patterns=$((dangerous_patterns + 1))
          fi

          echo "DANGEROUS_PATTERNS=$dangerous_patterns" >> $GITHUB_ENV
          echo "ðŸ’» Patterns dangereux trouvÃ©s: $dangerous_patterns"

      - name: ðŸ›¡ï¸ Vulnerability Scan
        if: ${{ inputs.scan_type == 'complete' || inputs.scan_type == 'vulnerability_scan' }}
        run: |
          echo "ðŸ›¡ï¸ Scan de vulnÃ©rabilitÃ©s Shopify..."

          # VÃ©rifier configurations de sÃ©curitÃ© Shopify
          security_issues=0

          echo "ðŸ” VÃ©rification CSP (Content Security Policy)..."
          if ! grep -r "Content-Security-Policy\|CSP" . > /dev/null 2>&1; then
            echo "âš ï¸ Pas de CSP dÃ©tectÃ©" >> "reports/security/$TIMESTAMP/vulnerability.log"
            security_issues=$((security_issues + 1))
          fi

          echo "ðŸ” VÃ©rification HTTPS enforcement..."
          if ! grep -r "force_ssl\|https" . > /dev/null 2>&1; then
            echo "âš ï¸ Configuration HTTPS Ã  vÃ©rifier" >> "reports/security/$TIMESTAMP/vulnerability.log"
            security_issues=$((security_issues + 1))
          fi

          echo "ðŸ” VÃ©rification protection XSS..."
          if ! grep -r "X-XSS-Protection\|xss" . > /dev/null 2>&1; then
            echo "âš ï¸ Protection XSS Ã  configurer" >> "reports/security/$TIMESTAMP/vulnerability.log"
            security_issues=$((security_issues + 1))
          fi

          echo "SECURITY_ISSUES=$security_issues" >> $GITHUB_ENV
          echo "ðŸ›¡ï¸ ProblÃ¨mes sÃ©curitÃ© dÃ©tectÃ©s: $security_issues"

      - name: ðŸ“Š Generate Security Report
        run: |
          echo "ðŸ“Š GÃ©nÃ©ration du rapport sÃ©curitÃ©..."

          # Calculer score sÃ©curitÃ© global
          total_issues=$((${SECRETS_FOUND:-0} + ${NPM_VULNERABILITIES:-0} + ${DANGEROUS_PATTERNS:-0} + ${SECURITY_ISSUES:-0}))

          cat > "reports/security/$TIMESTAMP/SECURITY_REPORT.md" << EOF
          # ðŸš¨ RAPPORT SÃ‰CURITÃ‰ - TPS BASE DEV

          **Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')
          **Type Scan:** ${{ inputs.scan_type || 'complete' }}
          **Commit:** ${GITHUB_SHA:0:8}

          ## ðŸ” DÃ©tection Secrets

          - **Secrets ExposÃ©s:** ${SECRETS_FOUND:-'Non testÃ©'}
          - **Status:** $(if [[ "${SECRETS_FOUND:-0}" == "0" ]]; then echo "âœ… SÃ©curisÃ©"; else echo "âŒ CRITIQUE"; fi)

          ## ðŸ“¦ Audit DÃ©pendances

          - **VulnÃ©rabilitÃ©s NPM:** ${NPM_VULNERABILITIES:-'Non testÃ©'}
          - **Status:** $(if [[ "${NPM_VULNERABILITIES:-0}" == "0" ]] || [[ "${NPM_VULNERABILITIES:-none}" == "none" ]]; then echo "âœ… SÃ©curisÃ©"; elif [[ "${NPM_VULNERABILITIES:-unavailable}" == "unavailable" ]]; then echo "âš ï¸ Non testÃ©"; else echo "âŒ VulnÃ©rabilitÃ©s dÃ©tectÃ©es"; fi)

          ## ðŸ’» QualitÃ© Code

          - **Patterns Dangereux:** ${DANGEROUS_PATTERNS:-'Non testÃ©'}
          - **Status:** $(if [[ "${DANGEROUS_PATTERNS:-0}" == "0" ]]; then echo "âœ… SÃ©curisÃ©"; else echo "âš ï¸ Ã€ rÃ©viser"; fi)

          ## ðŸ›¡ï¸ Analyse VulnÃ©rabilitÃ©s

          - **ProblÃ¨mes SÃ©curitÃ©:** ${SECURITY_ISSUES:-'Non testÃ©'}
          - **Status:** $(if [[ "${SECURITY_ISSUES:-0}" == "0" ]]; then echo "âœ… SÃ©curisÃ©"; else echo "âš ï¸ AmÃ©liorations requises"; fi)

          ## ðŸ“Š Score SÃ©curitÃ© Global

          **Total ProblÃ¨mes:** $total_issues

          $(if [[ $total_issues -eq 0 ]]; then
            echo "ðŸŸ¢ **EXCELLENT** - Aucun problÃ¨me dÃ©tectÃ©"
          elif [[ $total_issues -le 3 ]]; then
            echo "ðŸŸ¡ **BON** - Quelques points Ã  amÃ©liorer"
          elif [[ $total_issues -le 7 ]]; then
            echo "ðŸŸ  **MOYEN** - AmÃ©liorations recommandÃ©es"
          else
            echo "ðŸ”´ **CRITIQUE** - Action immÃ©diate requise"
          fi)

          ## ðŸŽ¯ Actions RecommandÃ©es

          $(if [[ "${SECRETS_FOUND:-0}" -gt 0 ]]; then
            echo "- ðŸš¨ **URGENT:** Retirer les secrets exposÃ©s du code"
          fi
          if [[ "${NPM_VULNERABILITIES:-0}" -gt 0 ]]; then
            echo "- ðŸ“¦ Mettre Ã  jour les dÃ©pendances vulnÃ©rables"
          fi
          if [[ "${DANGEROUS_PATTERNS:-0}" -gt 0 ]]; then
            echo "- ðŸ’» RÃ©viser le code avec patterns dangereux"
          fi
          if [[ "${SECURITY_ISSUES:-0}" -gt 0 ]]; then
            echo "- ðŸ›¡ï¸ Renforcer la configuration sÃ©curitÃ©"
          fi)

          ## ðŸ“… Planification

          - **Prochain scan:** $(date -d '+1 day' '+%Y-%m-%d')
          - **Scan complet:** Quotidien Ã  05h00 UTC
          - **Monitoring:** Automatique sur push

          ---

          **GÃ©nÃ©rÃ© par GitHub Actions Security Monitoring**
          EOF

          echo "âœ… Rapport sÃ©curitÃ© gÃ©nÃ©rÃ©"

      - name: ðŸš¨ Critical Alert Check
        run: |
          if [[ "${SECRETS_FOUND:-0}" -gt 0 ]]; then
            echo "ðŸš¨ ALERTE CRITIQUE: Secrets exposÃ©s dÃ©tectÃ©s!" >> $GITHUB_STEP_SUMMARY
            echo "**Action immÃ©diate requise**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: ðŸ“¤ Upload Security Report
        uses: actions/upload-artifact@v3
        with:
          name: security-report-${{ env.TIMESTAMP }}
          path: reports/security/${{ env.TIMESTAMP }}/
          retention-days: 60

      - name: ðŸ“ Display Security Summary
        run: |
          echo "## ðŸš¨ Rapport SÃ©curitÃ© TPS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ—“ï¸ Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ”„ Commit:** ${GITHUB_SHA:0:8}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ” RÃ©sultats Scan" >> $GITHUB_STEP_SUMMARY
          echo "- **Secrets ExposÃ©s:** ${SECRETS_FOUND:-'N/A'}" >> $GITHUB_STEP_SUMMARY
          echo "- **VulnÃ©rabilitÃ©s NPM:** ${NPM_VULNERABILITIES:-'N/A'}" >> $GITHUB_STEP_SUMMARY
          echo "- **Patterns Dangereux:** ${DANGEROUS_PATTERNS:-'N/A'}" >> $GITHUB_STEP_SUMMARY
          echo "- **ProblÃ¨mes SÃ©curitÃ©:** ${SECURITY_ISSUES:-'N/A'}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          total_issues=$((${SECRETS_FOUND:-0} + ${NPM_VULNERABILITIES:-0} + ${DANGEROUS_PATTERNS:-0} + ${SECURITY_ISSUES:-0}))

          if [[ $total_issues -eq 0 ]]; then
            echo "ðŸŸ¢ **Status:** EXCELLENT - Aucun problÃ¨me dÃ©tectÃ©" >> $GITHUB_STEP_SUMMARY
          elif [[ $total_issues -le 3 ]]; then
            echo "ðŸŸ¡ **Status:** BON - $total_issues point(s) Ã  amÃ©liorer" >> $GITHUB_STEP_SUMMARY
          elif [[ $total_issues -le 7 ]]; then
            echo "ðŸŸ  **Status:** MOYEN - $total_issues amÃ©liorations recommandÃ©es" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ”´ **Status:** CRITIQUE - $total_issues problÃ¨mes dÃ©tectÃ©s" >> $GITHUB_STEP_SUMMARY
          fi
